/****************************************************/
/*
 *
 *
 */
var aw_js_mentions_test = {
                              "stories"  :  [
                                                  {
                                                   count : 3,
                                                   id : 1,
                                                   name : "Pizza",
                                                   image : "https://usercontent.googleapis.com/freebase/v1/image/en/bob_dylan",
                                                   description : "https://www.googleapis.com/freebase/v1/text/en/bob_dylan",
      
                                                   source_name : "twitter",
                                                   source_msg_id :  "12233" 
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 2,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 3,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 14,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 12,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  }                                                  
                                                ],
                              "technology"  :  [
                                                  {
                                                   count : 3,
                                                   id : 16,
                                                   name : "Pizza",
                                                   image : "https://usercontent.googleapis.com/freebase/v1/image/en/bob_dylan",
                                                   description : "https://www.googleapis.com/freebase/v1/text/en/bob_dylan",
      
                                                   source_name : "twitter",
                                                   source_msg_id :  "12233"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 17,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 18,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 19,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  }                                                                                                    
                                                ],
                              "entertainment"  :  [
                                                   {
                                                   count : 3,
                                                   id : 10,
                                                   name : "Pizza",
                                                   image : "https://usercontent.googleapis.com/freebase/v1/image/en/bob_dylan",
                                                   description : "https://www.googleapis.com/freebase/v1/text/en/bob_dylan",
      
                                                   source_name : "twitter",
                                                   source_msg_id :  "12233"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 13,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 14,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },                                                  
                                                  {
                                                   count : 3,
                                                   id : 2,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },          
                                                  {
                                                   count : 3,
                                                   id : 3,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  }                                                                                                    
                                                ],
                                    "games"  :  [
                                                  {
                                                   count : 3,
                                                   id : 15,
                                                   name : "Pizza",
                                                   image : "https://usercontent.googleapis.com/freebase/v1/image/en/bob_dylan",
                                                   description : "https://www.googleapis.com/freebase/v1/text/en/bob_dylan",
      
                                                   source_name : "twitter",
                                                   source_msg_id :  "12233",
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 16,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 17,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 18,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 13,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  }                                                  
                                                ],
                                   "world"  :  [
                                                  {
                                                   count : 3,
                                                   id : 2,
                                                   name : "Pizza",
                                                   image : "https://usercontent.googleapis.com/freebase/v1/image/en/bob_dylan",
                                                   description : "https://www.googleapis.com/freebase/v1/text/en/bob_dylan",
      
                                                   source_name : "twitter",
                                                   source_msg_id :  "12233"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 3,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 16,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  }                                                                                                    
                                                ], 
                                   "products"  :  [
                                                  {
                                                   count : 3,
                                                   id : 1,
                                                   name : "Pizza",
                                                   image : "https://usercontent.googleapis.com/freebase/v1/image/en/bob_dylan",
                                                   description : "https://www.googleapis.com/freebase/v1/text/en/bob_dylan",
      
                                                   source_name : "twitter",
                                                   source_msg_id :  "12233"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 2,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 14,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 16,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  },
                                                  {
                                                   count : 3,
                                                   id : 18,
                                                   source_name :"facebook",
                                                   source_msg_id :  "267401179951379_373759045982258"
                                                  }                                                                                                                                                      
                                                ]                                                 

                          };

/****************************************************************/
/*
 *
 *
 */
var aw_pulled_mentions_handler_registry = {
                                            "facebook": function(context){
                                              aw_pulled_mention_facebook_handler(context);
                                            }                                           
                                         };
/*****************************************************************/
/*
*
*
*/
function aw_pulled_mentions_verified_facebook_cb(facebook_data, context){
  var mentions_cookie = {};
  var entity_list = "";
  $.each( facebook_data, function( index, post_data ){
    var pid = post_data.service.pid;
    if(context.foreign_id_look_up["facebook"][pid]){
      var array_offsets = context.foreign_id_look_up["facebook"][pid];
      $.each( array_offsets, function( index, offset){
         var mention_data = context.data_array[offset];
         var mention_id = mention_data.id;

         if(context.data_id_look_up["facebook"][mention_id]['cached']){

            context.data_array[offset]['name'] = context.data_id_look_up["facebook"][mention_id]['name']; 
            context.data_array[offset]['image'] = context.data_id_look_up["facebook"][mention_id]['image'];
            context.data_array[offset]['description'] = context.data_id_look_up["facebook"][mention_id]['description'];
            context.data_array[offset]['process']="done";
         }else{

            if( !context.relook.length ){
              context.relook = context.relook + mention_id;
            }else{
              context.relook = context.relook + "," +mention_id;              
            }
            context.data_array[offset]['process']="done";

         }

      });
    }

  });

 context.awaited_count--;
 if( !context.awaited_count ){
  aw_mentions_verified_fetch_details(context); 
 }

}
/****************************************************************/
/*
 *
 *
 */
function aw_pulled_mention_facebook_handler(context){
  var fb_data = context['services']['facebook'];
  var id_list_str = "";
  $.each( fb_data, function( index, post_id ){   
    if( id_list_str.length ){
      id_list_str = id_list_str + ',' + post_id;
    }else{
      id_list_str = post_id;
    }
                                                
  });
  aw_api_facebook_get_post_data_for_list_of_ids( id_list_str,
                                                 aw_pulled_mentions_verified_facebook_cb,
                                                 context);
}

/*****************************************************/
/*
 *
 *
 */
function aw_pulled_mentions_process_for_verification(context){
  $.each( context.services, function(service_name, id_list){
    if( aw_pulled_mentions_handler_registry[service_name] != null){
      context.awaited_count++;
      aw_pulled_mentions_handler_registry[service_name](context);
    }
  });

  if( !context.awaited_count ){
    aw_verified_mentions_render_all(context);
  }
}

/****************************************************/
/*
 *
 *
 */
function aw_mentions_verified_fetch_details(context){
  $.ajax({
            url: "/home/get_entities_verified",
            type: 'GET',
            data: {
                    user_id : aw_js_global_visited_user_credentials.id,
                    entity_ids : context.relook,
                    cache : aw_js_global_visited_user_credentials.cache_time
                  },
            dataType: 'json',
            contentType: 'application/json',
            success: function (mentions_data) {
              $.each( mentions_data, function( index, mention_data ){
                  var services_json = context.data_id_look_up;
                  $.each( services_json, function( service_name, per_mention_offests){

                    if( per_mention_offests[mention_data.id] ) {
                      var array_offsets = per_mention_offests[mention_data.id].array_offset;                    
                      if( array_offsets ) {
                        $.each( array_offsets, function( offset_index, offset){
                          if( !context.data_array[offset]['image'] &&
                               context.data_array[offset]['process'] == "done"){
                            if( mention_data.name ){
                              context.data_array[offset]['name'] = mention_data.name;
                            }

                            if( mention_data.image ){
                              context.data_array[offset]['image'] = mention_data.image;
                            }

                            if( mention_data.description ){
                              context.data_array[offset]['description'] = mention_data.description;
                            }
  
                          }
                            
                        });
                      }
                    }
                  });

              });             
               
              aw_verified_mentions_render_all(context);
            },
            error:function(XMLHttpRequest,textStatus, errorThrown){ 
              aw_verified_mentions_render_all(context);
              aw_lib_console_log("error",
                              "aw_mentions_verified_fetch_details:  Server request failed for "  
                              +  " error: " + errorThrown + " status:" + textStatus);   
        }
    });  
}


/****************************************************/
/*
 *
 *
 */
function aw_process_pulled_mention_data(data){
  var context={};
  context['fetched_data'] = data;
  context['data_array'] = [];
  context['data_id_look_up'] = {};
  context['foreign_id_look_up'] = {};
  context['services'] = {};
  context['verified'] = {};
  context['relook'] = "";
  context['awaited_count'] = 0;
  
  /* get a processable json ready and we are good */
  var total_mentions = 0;
  $.each(data, function( interest_name, mention_arr){
    if( mention_arr.length ){  
      total_mentions += mention_arr.length;
      $.each(mention_arr, function( index, mention_data){
        mention_data["interest_name"] = interest_name;
        
        if(  mention_data.image &&
               context.data_id_look_up[mention_data.source_name] &&
               context.data_id_look_up[mention_data.source_name][mention_data.id]){
               
               /* cache whatever is already found and be happy */
               context.data_id_look_up[mention_data.source_name][mention_data.id].verify = false;
        }       
        
        mention_data["process"] = "done";                 

        /* add all let verify and process decide the things */
        context.data_array.push(mention_data);

        /************/
        if( !context.data_id_look_up[mention_data.source_name] ){
          context.data_id_look_up[mention_data.source_name] = {};
        }

        if( !context.data_id_look_up[mention_data.source_name][mention_data.id]){
          context.data_id_look_up[mention_data.source_name][mention_data.id] = {
                                                                  "cached" : false,
                                                                  "array_offset" : [ context.data_array.length - 1 ]
                                                                              };
        }else{
          context.data_id_look_up[mention_data.source_name][mention_data.id].array_offset.push(context.data_array.length - 1);
        }

        var verify = true;
        if( mention_data.image ){
          verify = false;
          /* cache this to not fetch again from server */
          context.data_id_look_up[mention_data.source_name][mention_data.id]['cached'] = true;
          context.data_id_look_up[mention_data.source_name][mention_data.id]['name'] = mention_data.name;
          context.data_id_look_up[mention_data.source_name][mention_data.id]['image'] = mention_data.image;
          context.data_id_look_up[mention_data.source_name][mention_data.id]['description'] = mention_data.description;
        }

        if( verify ){      
          context.data_array[context.data_array.length - 1]["process"] = "awaited"; 
          /************/
          if( !context.foreign_id_look_up[mention_data.source_name] ){
                context.foreign_id_look_up[mention_data.source_name] = {};
          }
          
          if(  !context.foreign_id_look_up[mention_data.source_name][mention_data.source_msg_id]){
            context.foreign_id_look_up[mention_data.source_name][mention_data.source_msg_id] = [];
          }
          context.foreign_id_look_up[mention_data.source_name][mention_data.source_msg_id].push(context.data_array.length - 1);
          
          /************/
          if( !context.services[mention_data.source_name] ){
            context.services[mention_data.source_name] = [];
          }
          /* add the id to verify */
          context.services[mention_data.source_name].push(mention_data.source_msg_id);
        }

      });
    }
  });
  aw_pulled_mentions_process_for_verification(context);
}
/****************************************************/
/*
 *
 *
 */  
function aw_api_model_fetch_mentions(){
  $.ajax({

            url: "/home/get_entities.json",
            type: 'GET',
            data: { 
                    user_id :  aw_js_global_visited_user_credentials.id,
                    cache : aw_js_global_visited_user_credentials.cache_time,
                    a: 2
                  },
            dataType: 'json',
            contentType: 'application/json',
            success: function (data) {
              aw_process_pulled_mention_data(data);
            },
            error:function(XMLHttpRequest,textStatus, errorThrown){ 
              aw_lib_console_log("error",
                              "aw_api_model_fetch_mentions:  Server request failed for " 
                              +  " error: " + errorThrown + " status:" + textStatus);   
        }
    });
}

/****************************************************/
/*
 *
 *
 */
function aw_verified_mentions_render_all(context){
  if( context.data_array && context.data_array.length){
    var mention_count = {};
    var interest_names = [];
    var render_data_array = [];
    $.each(context.data_array, function(index, mention_data){
      if( typeof mention_count[mention_data.interest_name] == 'undefined' ){
        mention_count[mention_data.interest_name] = {};
        mention_count[mention_data.interest_name]['count'] = 0;
        mention_count[mention_data.interest_name]['indexes'] = [];

        interest_names.push(mention_data.interest_name);

      }
      mention_count[mention_data.interest_name].count++;
      mention_count[mention_data.interest_name].indexes.push(index);
    });

    interest_names.sort(function (interest_name1, interest_name2){
                                                                    return mention_count[interest_name2].count - mention_count[interest_name1].count;
                                                                  });

    $.each(interest_names, function( idx, interest_name){
      $.each( mention_count[interest_name].indexes, function( i, mention_index){
        context.data_array[mention_index]['total_mentions'] = mention_count[interest_name].count;
        render_data_array.push( context.data_array[mention_index] );
      });
    });
    context.data_array = render_data_array;
  }
  aw_api_controller_render_mentions(context.data_array);
}

/****************************************************/
/*
 *
 *
 */                                         
function aw_api_model_mentions_initialize(){
  /* make a get call to server */
  aw_api_model_fetch_mentions();
}




/*
 *  Merge all mentions data to form a unique set of mentions
 */
function aw_api_model_merge_mentions_data(data)
{
  var mentions_data = data;
  var mentions_array = {};
  $.each( mentions_data, function( key, mention) {
      
      var name = mention.name; 
      if (!mentions_array[name]) {
          mentions_array[name] = {
                                   id: mention.id,
                                   name : mention.name
                                 };
      }
  });
  aw_cache_api_set_data("aw.mentions.data", mentions_array);
}
